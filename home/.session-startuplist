#!/bin/bash
# contains userspace programs to start during startup

# Note if you leave last command without '&' (i.e. won't fork to background),
# you can exit your session by simply ending that application.
#---------------------------------------------------
PROGS=(
    "urxvtd"
    "davmail"
    "skype"
    "spacefm"
    "keepassx"
    "copyq"
    "mbsync --all"
    "delay_screensaver"
    "urxvtc"
    "xfce4-volumed"
    guake

    "Earth_sunlight_wallpaper_changer.sh"
    "sunlight_map_wallpaper_changer.sh"
    "wait_for_suspend_to_lock_screen.sh"
)

# oldies:
    #"icedove" \
    #"volti" \
    #"parcellite" \
    #"delay_screensaver.py" \
    #"blueman-applet"
    #"nm-applet"
    #"xfce4-power-manager"
    #"ssh-agent"

# alternative to lock automatically when suspending/hibernating: (requires xss-lock)
# (currently using the shellscript that listens to dbus messages)
# xss-lock -- xscreensaver-command -lock &
#
#---------------------------------------------------
# import common:
if ! type __COMMONS_LOADED_MARKER > /dev/null 2>&1; then
    if [[ -r "$_SCRIPTS_COMMONS" ]]; then
        source "$_SCRIPTS_COMMONS"
    else
        echo -e "\nError: common file \"$_SCRIPTS_COMMONS\" not found!"
        #exit 1   # prolly not a good idea to exit here
    fi
fi
#---------------------------------------------------

# TODO: delete this?:
#export DISPLAY=:0.0

# See policykit k채itati tavaliste DE-de puhul /etc/xdg/autostart/polkit-gnome....desktop-ist;
# kui ei k채ivitanud, siis andis network-manager wireless v천rku 체hendamisel permission errori:
# teine variant, kuidas soovitatakse NM permission errorist jagu saada:
# loo fail  /etc/polkit-1/localauthority/50-local.d/org.freedesktop.NetworkManager.pkla sisuga:
#[nm-applet]
#Identity=unix-group:netdev
#Action=org.freedesktop.NetworkManager.*
#ResultAny=yes
#ResultInactive=no
#ResultActive=yes

/usr/lib/policykit-1-gnome/polkit-gnome-authentication-agent-1 &
/usr/bin/gnome-keyring-daemon --start --components=secrets,ssh &

for PROG in "${PROGS[@]}"; do
    if ! is_proc_running "$PROG"; then
        echo "Launching ${PROG}..."
        $PROG &
        echo "Launched $PROG."
    fi
done

# sets the cursor icon; Available themes reside in /usr/share/icons and local themes can be installed to ~/.icons.:
#xsetroot -cursor_name left_ptr &

#launchy &

# set wallpaper (afterwards, script will be run periodically by cron):
wallpaper_changer.sh > /dev/null 2>&1 &

#if ! [[ "$(ps -e | grep "\bmpd\b")" ]]; then
    #mpd /etc/mpd.conf &
    #echo "Launching mpd..."
#fi
if ! is_proc_running mopidy; then
    mopidy &
    echo "Launching mopidy"
fi

#if ! is_proc_running dropbox; then
    #dropbox start &
    #echo "Launching dropbox..."
#fi

if ! is_proc_running xscreensaver; then
    xscreensaver -no-splash &
    echo "Launching xscreensaver..."
fi

if ! is_proc_running syndaemon && is_laptop; then
    syndaemon -t -K -i 4 &
    echo "Launching syndaemon..."
fi

if ! is_proc_running transmission_somethiNG_TODO && ! is_work; then
    # TODO: start transmission? client, server? where?
    true
fi

# synergy:
if is_laptop; then
    if ! is_proc_running synergyc; then
        echo "Launching syndergy client"

        if is_work; then
            # if need to change the command, make sure to update in acpi lid handler (laptop_lid_event.sh) as well:
            synergyc -f --no-tray --debug INFO --name work-laptop 10.180.18.149:24800 &
            #/data/progs/custom_builds/synergy/bin/synergyc -f --no-tray --debug INFO --name work-laptop 10.180.18.149:24800 &
        else
            # TODO personal laptop
            echo "TODO"
        fi

        setxkbmap ee &  # otherwise using server's keyboard defaults to us map;
    fi
else    # is NOT laptop, assuming desktop
    if ! is_proc_running synergys; then
        echo "Launching syndergy server"

        if is_work; then
            synergys -f --no-tray --debug INFO --name work-desktop -c ~/synergy.conf --log $CUSTOM_LOGDIR/synergy_server.log --address :24800 &
            #/data/progs/custom_builds/synergy/bin/synergys -f --no-tray --debug INFO --name work-desktop -c ~/synergy.conf --log $CUSTOM_LOGDIR/synergy_server.log --address :24800 &
        else
            # TODO personal deskderp
            echo "TODO"
        fi
    fi
fi

###############################
# modify configs:
if is_laptop; then
    sed --follow-symlinks -i '/^lockTimeout:/s/^lockTimeout:.*/lockTimeout:\t0:00:05/g' ~/.xscreensaver &
fi


# nvidia bug report:
#sleep 5;
#sudo nvidia-bug-report.sh >> /tmp/minuNVIDlog.log
#sleep 10;
#msmtp -t < /tmp/logs_to_send.log >> /tmp/minuMSMTP.log

